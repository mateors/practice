PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;
CREATE TABLE schema_version ( version INTEGER NOT NULL );
INSERT INTO schema_version VALUES(5);
CREATE TABLE users (
			id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
			username VARCHAR(255) NOT NULL UNIQUE,
			msgsizelimit INTEGER DEFAULT NULL,

            -- It does not reference mboxes, since otherwise there will
            -- be recursive foreign key constraint.
            inboxId BIGINT DEFAULT 0
		);
INSERT INTO users VALUES(1,'postmaster@mostain.net',NULL,1);
CREATE TABLE mboxes (
			id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
			uid INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
			name VARCHAR(255) NOT NULL,
			sub INTEGER NOT NULL DEFAULT 1,
			mark INTEGER NOT NULL DEFAULT 0,
			msgsizelimit INTEGER DEFAULT NULL,
			uidnext INTEGER NOT NULL DEFAULT 1,
			uidvalidity BIGINT NOT NULL,
            specialuse VARCHAR(255) DEFAULT NULL,

            msgsCount INTEGER NOT NULL DEFAULT 0,

			UNIQUE(uid, name)
		);
INSERT INTO mboxes VALUES(1,1,'INBOX',1,0,NULL,2,3877488780,NULL,1);
INSERT INTO mboxes VALUES(2,1,'Sent',1,0,NULL,1,574012639,'\Sent',0);
INSERT INTO mboxes VALUES(3,1,'Trash',1,0,NULL,1,3614382348,'\Trash',0);
INSERT INTO mboxes VALUES(4,1,'Junk',1,0,NULL,1,3883107061,'\Junk',0);
INSERT INTO mboxes VALUES(5,1,'Drafts',1,0,NULL,1,2712265491,'\Drafts',0);
INSERT INTO mboxes VALUES(6,1,'Archive',1,0,NULL,1,3601831364,'\Archive',0);
CREATE TABLE extKeys (
			id VARCHAR(255) PRIMARY KEY NOT NULL,

			-- REFERENCES constraint is commented out otherwise
			-- it will be impossible to delete user without
			-- doing multiple queries to delete mboxes and stuff
			-- or using deferred constraint checking (not supported by MySQL/MariaDB)
			uid BIGINT NOT NULL, -- REFERENCES users(id) ON DELETE RESTRICT
			refs INTEGER NOT NULL DEFAULT 1
		);
INSERT INTO extKeys VALUES('8f42d81a486265fc478210662b5e7db6',1,1);
CREATE TABLE msgs (
			mboxId BIGINT NOT NULL REFERENCES mboxes(id) ON DELETE CASCADE,
			msgId BIGINT NOT NULL,
			date BIGINT NOT NULL,
			bodyLen INTEGER NOT NULL,
			mark INTEGER NOT NULL DEFAULT 0,

			bodyStructure LONGTEXT NOT NULL,
			cachedHeader LONGTEXT NOT NULL,
			extBodyKey VARCHAR(255) DEFAULT NULL REFERENCES extKeys(id) ON DELETE RESTRICT,

            seen INTEGER NOT NULL DEFAULT 0,

			compressAlgo VARCHAR(255),

			PRIMARY KEY(mboxId, msgId)
		);
INSERT INTO msgs VALUES(1,1,1634270038,4518,0,X'7b224d494d4554797065223a2274657874222c224d494d4553756254797065223a22706c61696e222c22506172616d73223a7b2263686172736574223a225554462d38227d2c224964223a22222c224465736372697074696f6e223a22222c22456e636f64696e67223a22222c2253697a65223a313832362c225061727473223a6e756c6c2c22456e76656c6f7065223a6e756c6c2c22426f6479537472756374757265223a6e756c6c2c224c696e6573223a33372c22457874656e646564223a747275652c22446973706f736974696f6e223a22222c22446973706f736974696f6e506172616d73223a6e756c6c2c224c616e6775616765223a6e756c6c2c224c6f636174696f6e223a6e756c6c2c224d4435223a22227d',X'7b2244656c6976657265642d546f223a5b22706f73746d6173746572406d6f737461696e2e6e6574225d2c224d6573736167652d4964223a5b225c75303033634341486842537a4c3d366a2b34737861414642433d6d7553316e4d783251725a2b434b71796e6856773177683d683637465077406d61696c2e676d61696c2e636f6d5c7530303365225d2c22546f223a5b22706f73746d6173746572406d6f737461696e2e6e6574225d2c225375626a656374223a5b22476d61696c20436f6e6669726d6174696f6e202d2053656e64204d61696c20617320706f73746d6173746572406d6f737461696e2e6e6574225d2c22436f6e74656e742d54797065223a5b22746578742f706c61696e3b20636861727365743d5c225554462d385c22225d2c2246726f6d223a5b22476d61696c205465616d205c7530303363676d61696c2d6e6f7265706c7940676f6f676c652e636f6d5c7530303365225d2c2252657475726e2d50617468223a5b225c7530303363676d61696c2d6e6f7265706c7940676f6f676c652e636f6d5c7530303365225d2c2244617465223a5b224672692c203135204f637420323032312030393a35333a3537202b30363030225d7d','8f42d81a486265fc478210662b5e7db6',0,'');
CREATE TABLE flags (
			mboxId BIGINT NOT NULL,
			msgId BIGINT NOT NULL,
			flag VARCHAR(255) NOT NULL,

			FOREIGN KEY (mboxId, msgId) REFERENCES msgs(mboxId, msgId) ON DELETE CASCADE,
			UNIQUE (mboxId, msgId, flag)
		);
INSERT INTO flags VALUES(1,1,'\Recent');
ANALYZE sqlite_master;
INSERT INTO sqlite_stat1 VALUES('flags','sqlite_autoindex_flags_1','1 1 1 1');
INSERT INTO sqlite_stat1 VALUES('msgs','seen_msgs','1 1 1');
INSERT INTO sqlite_stat1 VALUES('msgs','sqlite_autoindex_msgs_1','1 1 1');
INSERT INTO sqlite_stat1 VALUES('extKeys','extKeys_uid_id','1 1 1');
INSERT INTO sqlite_stat1 VALUES('extKeys','sqlite_autoindex_extKeys_1','1 1');
INSERT INTO sqlite_stat1 VALUES('mboxes','sqlite_autoindex_mboxes_1','6 6 1');
DELETE FROM sqlite_sequence;
INSERT INTO sqlite_sequence VALUES('users',1);
INSERT INTO sqlite_sequence VALUES('mboxes',6);
CREATE INDEX extKeys_uid_id
        ON extKeys(uid, id);
CREATE INDEX seen_msgs
        ON msgs(mboxId, seen);
COMMIT;
